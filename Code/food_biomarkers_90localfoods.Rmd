---
title: "UK_foods"
author: "Harsha Gouda"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.show = 'hide')
setwd("C:/Users/XXX") #wroking directory
library(tidyverse)
library(mixOmics)
library(stringr)
library(ggplot2)
library(ggpubr)
library(vegan)
library(tibble)
library(CoDaSeq)
library(dplyr)
```

```{r data_import}
#read_file
feature_table <- read_csv("UK_foods_iimn_gnps_quant.csv") #feature table
metadata <- read_csv("Food_classes.csv") %>% arrange(filename) #metadata

#data_transpose
data_transpose <- feature_table %>% 
  column_to_rownames("row ID") %>% 
  dplyr::select(contains(".mzML")) %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("filename")


#remove Peak area from filename from feature table
data_transpose$filename <- gsub(" Peak area", "", data_transpose$filename)
data_transpose <- data_transpose %>% arrange(filename)
data_transpose$filename <- trimws(data_transpose$filename)
metadata$filename <- trimws(metadata$filename)

m_filter <- metadata %>%
  filter(!str_detect(filename, "QC|blank|S16_frozen"))

data_transpose <- data_transpose %>% 
  filter(filename %in% m_filter$filename)

#rclr normalisation
data_clr <- codaSeq.clr(column_to_rownames(data_transpose, var = "filename") + 1) %>% as.data.frame() 
clr_data <- data_clr %>%  rownames_to_column("filename") %>% arrange(filename)
clr_data$filename <- trimws(clr_data$filename)
metadata$filename <- trimws(metadata$filename)

#filter_data
filter_data <- clr_data %>%
  filter(filename %in% m_filter$filename) 
```

```{r PCA}
#PCA analysis#
PCA_whole <- mixOmics::pca(filter_data, ncomp = 4, scale = TRUE)
PCA_whole_scores <- data.frame(PCA_whole$variates$X, m_filter)
PCA_plot <- PCA_whole_scores %>%
  ggscatter(x = "PC1", y = "PC2", color = "L2_Category", alpha = 1, size = 2,
            title = paste("PCA", "Simple Foods", sep = " "),
            xlab = paste("PC1 (", round(PCA_whole$prop_expl_var$X[1]*100, digits = 2),"%)", sep = ""), 
            ylab = paste("PC2 (", round(PCA_whole$prop_expl_var$X[2]*100, digits = 2),"%)", sep = ""),
            ggtheme = theme_bw()) +
  stat_ellipse(aes(colour = L2_Category), alpha = 1) + 
  geom_point(
    data = PCA_whole_scores %>% 
      group_by(L2_Category) %>% 
      summarise(across(matches("PC"), mean)),  # Calculate mean PC1 and PC2
    aes(PC1, PC2, color = L2_Category), 
    size = 4, 
    shape = 8  # Star-shaped marker for centroids
  ) +
  theme(plot.title = element_text(size = 20, colour = "black"),
        axis.title = element_text(size = 20),
        axis.text = element_text(size = 20, face = "bold"),
        panel.border = element_rect(color = "black", size = 1.5)) +  # Adjust border color and thickness here
  coord_fixed()

plot(PCA_plot)
#ggsave("PCA_Plasma_visit_code.tiff", plot = PCA_plot, dpi = 500, width = 8, height = 6)

```

```{r Loop everything}
library(mixOmics)
library(tidyverse)

### 1. PREPARE DATA ###

# The grouping variable is stored in sample_group.
sample_group <- PCA_whole_scores$Sample_group1
PCA_whole_scores$Sample_group1 <- as.factor(sample_group)

# Prepare numeric data for PLS-DA.
filter_data <- filter_data %>%
  column_to_rownames("filename") %>%
  dplyr::select(where(is.numeric))

# Prepare Milk data from data_transpose.
Global <- data_transpose %>% 
  column_to_rownames("filename") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("#Scan#")

Global <- Global %>% column_to_rownames("#Scan#")

### 2. LOOP OVER EACH CATEGORY ###
categories <- unique(m_filter$Sample_group1)
all_features <- data.frame()  # To store features passing both filters

for (cat in categories) {
  
  #### A. PLS-DA & VIP Extraction ####
  # Create a binary grouping: current category vs. all others
  binary_group <- ifelse(m_filter$Sample_group1 == cat, cat, "Other")
  
  # Run PLS-DA using the numeric data
  PLSDA_model <- mixOmics::plsda(filter_data, binary_group, ncomp = 5, scale = TRUE)
  
  # Extract VIP scores and loadings (using component 1)
  vip_scores <- mixOmics::vip(PLSDA_model)
  loadings   <- as.data.frame(PLSDA_model$loadings$X)
  
  # Combine into a results data frame
  vip_results <- data.frame(
    Feature  = rownames(vip_scores),
    VIP      = vip_scores[, 1],
    Loading  = loadings[, 1],
    category = cat,
    stringsAsFactors = FALSE
  )
  
  # Filter for features with VIP > 1.5 and positive loading
  important_vip <- vip_results %>% 
    filter(VIP > 1.5, Loading > 0)
  
  # Select the top 10 features based on VIP score from those that are high in the category
  top_metabolites <- important_vip %>%
    arrange(desc(VIP)) %>%
    slice_max(order_by = VIP, n = 40) %>%
    mutate(Method = "Top20_VIP_High")
  
  #### C. Append Results ####
  # Append selected metabolites to the final results
  all_features <- bind_rows(all_features, top_metabolites)
}


### 3. Summarize Biomarkers ###
biomarkers <- all_features %>% 
  group_by(Feature) %>% 
  summarise(
    category = paste(unique(category), collapse = ", "),
    Method   = paste(unique(Method), collapse = ", ")
  ) %>% 
  ungroup() %>% 
  as.data.frame()

### 4. VIEW OR SAVE RESULTS ###
head(all_features)
head(biomarkers)

# Optionally, export the results:
# write.csv(all_features, "Features_VIP_FoldChange.csv", row.names = FALSE)
write.csv(biomarkers, "UK_biomarkers_samplegroup.csv", row.names = FALSE)

```

